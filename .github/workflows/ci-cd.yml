name: Production CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      environment:
        description: "Target environment (staging|production)"
        required: false
        default: "production"
      rollback_to:
        description: "Optional version tag to rollback to (e.g., v123)"
        required: false

concurrency:
  group: prod-cicd-${{ github.ref }}
  cancel-in-progress: ${{ github.ref != 'refs/heads/main' }}

env:
  DOCKER_REGISTRY: docker.io
  FRONTEND_IMAGE: cynerza/cynerza-frontend-web
  BACKEND_IMAGE: cynerza/cynerza-backend-web
  NODE_VERSION: '20'

jobs:
  changes:
    runs-on: ubuntu-latest
    outputs:
      frontend: ${{ steps.filter.outputs.frontend }}
      backend: ${{ steps.filter.outputs.backend }}
      ci: ${{ steps.filter.outputs.ci }}
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    - name: Paths filter
      id: filter
      uses: dorny/paths-filter@v3
      with:
        filters: |
          frontend:
            - 'src/**'
            - 'public/**'
            - 'index.html'
            - 'vite.config.*'
            - 'tsconfig*.json'
            - 'Dockerfile'
            - 'package.json'
            - 'package-lock.json'
          backend:
            - 'CYNERZA-ADMIN-BACKEND/**'
          ci:
            - '.github/**'
            - 'Dockerfile*'
  security-scan:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'table'
        exit-code: '1'
        ignore-unfixed: true
        severity: 'CRITICAL,HIGH'

    - name: Check for hardcoded secrets in code
      run: |
        echo "üîç Scanning for hardcoded secrets..."
        
        FINDINGS=""
        
        API_KEYS=$(grep -r -E '['"'"']?(sk-|pk_|rk_|ak_)[a-zA-Z0-9]{20,}['"'"']?' --include="*.js" --include="*.ts" --exclude-dir=node_modules . || true)
        if [ -n "$API_KEYS" ]; then
          FINDINGS="$FINDINGS\nHardcoded API Keys:\n$API_KEYS"
        fi
        
        AWS_KEYS=$(grep -r -E '['"'"'"](AKIA[0-9A-Z]{16})['"'"'"]' --include="*.js" --include="*.ts" --exclude-dir=node_modules . || true)
        if [ -n "$AWS_KEYS" ]; then
          FINDINGS="$FINDINGS\nAWS Keys:\n$AWS_KEYS"
        fi
        
        GH_TOKENS=$(grep -r -E '['"'"'"](ghp_|gho_|ghu_|ghs_)[a-zA-Z0-9]{36,}['"'"'"]' --include="*.js" --include="*.ts" --exclude-dir=node_modules . || true)
        if [ -n "$GH_TOKENS" ]; then
          FINDINGS="$FINDINGS\nGitHub Tokens:\n$GH_TOKENS"
        fi
        
        HARDCODED_PASSWORDS=$(grep -r -E 'password\s*[:=]\s*['"'"'"][^'"'"'"process.env][^'"'"'"\s]{8,}['"'"'"]' --include="*.js" --include="*.ts" --exclude-dir=node_modules . | grep -v -E "(type\s|interface\s|String,|string;)" || true)
        if [ -n "$HARDCODED_PASSWORDS" ]; then
          FINDINGS="$FINDINGS\nHardcoded Passwords:\n$HARDCODED_PASSWORDS"
        fi
        
        DB_URLS=$(grep -r -E '(mongodb|postgres|mysql)://[^:]+:[^@/]+@' --include="*.js" --include="*.ts" --exclude-dir=node_modules . | grep -v "process.env" || true)
        if [ -n "$DB_URLS" ]; then
          FINDINGS="$FINDINGS\nDatabase URLs with credentials:\n$DB_URLS"
        fi
        
        JWT_SECRETS=$(grep -r -E 'jwt.*secret.*[:=]\s*['"'"'"][^'"'"'"process.env][^'"'"'"\s]{16,}['"'"'"]' --include="*.js" --include="*.ts" --exclude-dir=node_modules . || true)
        if [ -n "$JWT_SECRETS" ]; then
          FINDINGS="$FINDINGS\nJWT Secrets:\n$JWT_SECRETS"
        fi
        
        if [ -n "$FINDINGS" ]; then
          echo -e "‚ùå Potential hardcoded secrets found:$FINDINGS"
          echo ""
          echo "Please ensure secrets are stored in environment variables, not hardcoded in source code."
          exit 1
        else
          echo "‚úÖ No hardcoded secrets detected"
        fi

    - name: Check for security vulnerabilities in dependencies
      run: |
        echo "üîç Checking for dependency vulnerabilities..."
        
        if [ -f "package-lock.json" ]; then
          npm audit --audit-level=high --production || {
            echo "‚ùå Frontend dependencies have high/critical vulnerabilities"
            echo "Run 'npm audit fix' to resolve issues"
            exit 1
          }
        fi
        
        if [ -f "CYNERZA-ADMIN-BACKEND/package-lock.json" ]; then
          cd CYNERZA-ADMIN-BACKEND
          npm audit --audit-level=high --production || {
            echo "‚ùå Backend dependencies have high/critical vulnerabilities"
            echo "Run 'npm audit fix' in CYNERZA-ADMIN-BACKEND to resolve issues"
            exit 1
          }
          cd ..
        fi
        
        echo "‚úÖ No high/critical dependency vulnerabilities found"

    - name: Check Dockerfile security best practices
      run: |
        echo "üîç Checking Dockerfile security..."
        
        DOCKERFILE_ISSUES=""
        
        if [ -f "Dockerfile" ]; then
          if ! grep -q "USER.*[^0]" Dockerfile; then
            DOCKERFILE_ISSUES="$DOCKERFILE_ISSUES\n- Frontend Dockerfile: Should run as non-root user"
          fi
          
          if grep -q "FROM.*:latest" Dockerfile; then
            DOCKERFILE_ISSUES="$DOCKERFILE_ISSUES\n- Frontend Dockerfile: Avoid using ':latest' tag, pin specific versions"
          fi
        fi
        
        if [ -f "CYNERZA-ADMIN-BACKEND/Dockerfile" ]; then
          if ! grep -q "USER.*[^0]" CYNERZA-ADMIN-BACKEND/Dockerfile; then
            DOCKERFILE_ISSUES="$DOCKERFILE_ISSUES\n- Backend Dockerfile: Should run as non-root user"
          fi
          
          if grep -q "FROM.*:latest" CYNERZA-ADMIN-BACKEND/Dockerfile; then
            DOCKERFILE_ISSUES="$DOCKERFILE_ISSUES\n- Backend Dockerfile: Avoid using ':latest' tag, pin specific versions"
          fi
        fi
        
        if [ -n "$DOCKERFILE_ISSUES" ]; then
          echo -e "‚ö†Ô∏è Dockerfile security recommendations:$DOCKERFILE_ISSUES"
          echo ""
          echo "Consider addressing these security best practices."
        else
          echo "‚úÖ Dockerfile security checks passed"
        fi

  frontend-build:
    runs-on: ubuntu-latest
    needs: [security-scan, changes]
    if: needs.changes.outputs.frontend == 'true'
    outputs:
      build-success: ${{ steps.build-check.outputs.success }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: Install frontend dependencies
      run: |
        if [ -f "package-lock.json" ]; then
          echo "Using npm ci"
          npm ci
        else
          echo "package-lock.json not found. Falling back to npm install"
          npm install --no-audit --no-fund
        fi

    - name: Run ESLint
      run: npm run lint

    - name: Run TypeScript check
      run: npx tsc --noEmit

    - name: Build frontend
      run: npm run build

    - name: Upload frontend preview (PR)
      if: github.event_name == 'pull_request'
      uses: actions/upload-artifact@v4
      with:
        name: frontend-dist-${{ github.sha }}
        path: ./dist
        retention-days: 7

    - name: Test frontend build
      id: build-check
      run: |
        if [ -d "dist" ] && [ "$(ls -A dist)" ]; then
          echo "‚úÖ Frontend build successful"
          echo "success=true" >> $GITHUB_OUTPUT
        else
          echo "‚ùå Frontend build failed - dist directory empty"
          echo "success=false" >> $GITHUB_OUTPUT
          exit 1
        fi

    - name: Cache frontend dist
      if: success()
      uses: actions/cache/save@v3
      with:
        path: ./dist
        key: frontend-dist-${{ github.sha }}

  backend-build:
    runs-on: ubuntu-latest
    needs: [security-scan, changes]
    if: needs.changes.outputs.backend == 'true'
    defaults:
      run:
        working-directory: ./CYNERZA-ADMIN-BACKEND
    outputs:
      build-success: ${{ steps.build-check.outputs.success }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: './CYNERZA-ADMIN-BACKEND/package-lock.json'

    - name: Install backend dependencies
      run: |
        if [ -f "package-lock.json" ]; then
          echo "Using npm ci"
          npm ci
        else
          echo "package-lock.json not found. Falling back to npm install"
          npm install --no-audit --no-fund
        fi

    - name: Validate backend startup
      run: |
        echo "Starting backend validation..."
        
        export NODE_ENV=development
        export PORT=3776
        export MONGODB_URL="mongodb://localhost:27017/test"
        export CLOUDNIRY_CLOUD_NAME="test"
        export CLOUDNIRY_API_KEY="test"
        export CLOUDNIRY_API_SECRET="test"
        export ACCESS_TOKEN_SECRET="test-secret"
        export REFRESH_TOKEN_SECRET="test-refresh-secret"
        
        timeout 30s npm run dev &
        PID=$!
        
        sleep 15
        
        if kill -0 $PID 2>/dev/null; then
          echo "‚úÖ Backend starts successfully"
          kill $PID
          wait $PID 2>/dev/null || true
        else
          echo "‚ùå Backend failed to start"
          exit 1
        fi

    - name: Run backend build check
      id: build-check
      run: |
        npm run build
        echo "‚úÖ Backend build successful"
        echo "success=true" >> $GITHUB_OUTPUT

    - name: Cache backend src
      if: success()
      uses: actions/cache/save@v3
      with:
        path: ./CYNERZA-ADMIN-BACKEND/src
        key: backend-src-${{ github.sha }}

  docker-build-push:
    runs-on: ubuntu-latest
    needs: [changes, frontend-build, backend-build]
    if: success() && github.event_name != 'pull_request'
    outputs:
      frontend-image-tag: ${{ env.FRONTEND_IMAGE }}:${{ github.sha }}
      backend-image-tag: ${{ env.BACKEND_IMAGE }}:${{ github.sha }}
      frontend-image-digest: ${{ steps.frontend-build.outputs.digest }}
      backend-image-digest: ${{ steps.backend-build.outputs.digest }}
    
    steps:
    - name: Set up QEMU (multi-arch)
      uses: docker/setup-qemu-action@v3

    - name: Verify both builds succeeded (consider skipped ok)
      run: |
        echo "üîç Verifying both frontend and backend builds succeeded (skipped treated as OK)..."
        
        FRONTEND_RESULT="${{ needs.frontend-build.result }}"
        BACKEND_RESULT="${{ needs.backend-build.result }}"
        
        echo "Frontend job result: $FRONTEND_RESULT"
        echo "Backend job result: $BACKEND_RESULT"
        
        ok() { [ "$1" = "success" ] || [ "$1" = "skipped" ]; }
        if ok "$FRONTEND_RESULT" && ok "$BACKEND_RESULT"; then
          echo "‚úÖ Preconditions met - proceeding with Docker push"
        else
          echo "‚ùå One or both preconditions failed - aborting Docker push"
          exit 1
        fi

    - name: Checkout code
      uses: actions/checkout@v4

    - name: Restore frontend dist cache
      if: needs.frontend-build.result == 'success'
      uses: actions/cache/restore@v3
      with:
        path: ./dist
        key: frontend-dist-${{ github.sha }}
        fail-on-cache-miss: false

    - name: Restore backend src cache
      if: needs.backend-build.result == 'success'
      uses: actions/cache/restore@v3
      with:
        path: ./CYNERZA-ADMIN-BACKEND/src
        key: backend-src-${{ github.sha }}
        fail-on-cache-miss: false

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to Docker Hub
      uses: docker/login-action@v3
      with:
        registry: ${{ env.DOCKER_REGISTRY }}
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    - name: Create Docker repositories if needed
      run: |
        echo "üì¶ Ensuring Docker Hub repositories are ready..."
        
        create_repo_if_needed() {
          local repo_name=$1
          local image_name=$2
          
          echo "Checking repository: $image_name"
          
          REPO_EXISTS=$(curl -s -o /dev/null -w "%{http_code}" \
            "https://hub.docker.com/v2/repositories/$image_name/" || echo "000")
          
          if [ "$REPO_EXISTS" = "200" ]; then
            echo "‚úÖ Repository $image_name exists"
          else
            echo "‚ö†Ô∏è Repository $image_name does not exist - will be created on push"
            echo "Make sure your Docker Hub account has permission to create repositories"
          fi
        }
        
        create_repo_if_needed "frontend" "${{ env.FRONTEND_IMAGE }}"
        create_repo_if_needed "backend" "${{ env.BACKEND_IMAGE }}"

    - name: Extract metadata for Frontend Docker
      id: frontend-meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.FRONTEND_IMAGE }}
        tags: |
          type=ref,event=branch
          type=ref,event=pr
          type=sha
          type=semver,pattern={{version}}
          type=semver,pattern={{major}}.{{minor}}
          type=raw,value=v${{ github.run_number }}
          type=raw,value=latest,enable={{is_default_branch}}

    - name: Extract metadata for Backend Docker
      id: backend-meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.BACKEND_IMAGE }}
        tags: |
          type=ref,event=branch
          type=ref,event=pr
          type=sha
          type=semver,pattern={{version}}
          type=semver,pattern={{major}}.{{minor}}
          type=raw,value=v${{ github.run_number }}
          type=raw,value=latest,enable={{is_default_branch}}

    - name: Build and push Frontend Docker image
      id: frontend-build
      uses: docker/build-push-action@v5
      if: needs.changes.outputs.frontend == 'true'
      with:
        context: .
        file: ./Dockerfile
        push: true
        tags: ${{ steps.frontend-meta.outputs.tags }}
        labels: ${{ steps.frontend-meta.outputs.labels }}
        platforms: linux/amd64,linux/arm64
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: Build and push Backend Docker image
      id: backend-build
      uses: docker/build-push-action@v5
      if: needs.changes.outputs.backend == 'true'
      with:
        context: ./CYNERZA-ADMIN-BACKEND
        file: ./CYNERZA-ADMIN-BACKEND/Dockerfile
        push: true
        tags: ${{ steps.backend-meta.outputs.tags }}
        labels: ${{ steps.backend-meta.outputs.labels }}
        platforms: linux/amd64,linux/arm64
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: Trivy scan Frontend image
      uses: aquasecurity/trivy-action@master
      if: needs.changes.outputs.frontend == 'true'
      with:
        image-ref: ${{ env.FRONTEND_IMAGE }}:main
        format: 'table'
        exit-code: '1'
        ignore-unfixed: true
        severity: 'CRITICAL,HIGH'

    - name: Trivy scan Backend image
      uses: aquasecurity/trivy-action@master
      if: needs.changes.outputs.backend == 'true'
      with:
        image-ref: ${{ env.BACKEND_IMAGE }}:main
        format: 'table'
        exit-code: '1'
        ignore-unfixed: true
        severity: 'CRITICAL,HIGH'
        
    - name: Verify both pushes succeeded
      run: |
        echo "üîç Verifying Docker image pushes for changed components..."

        VERIFY_OK=true

        if [ "${{ needs.changes.outputs.frontend }}" = "true" ]; then
          FRONTEND_TAG="${{ env.FRONTEND_IMAGE }}:main"
          echo "Checking frontend: $FRONTEND_TAG"
          if docker manifest inspect "$FRONTEND_TAG" >/dev/null 2>&1; then
            echo "‚úÖ Frontend image successfully pushed: $FRONTEND_TAG"
          else
            echo "‚ùå Failed to verify frontend image push"
            VERIFY_OK=false
          fi
        else
          echo "‚ÑπÔ∏è Frontend unchanged, skipping verify"
        fi

        if [ "${{ needs.changes.outputs.backend }}" = "true" ]; then
          BACKEND_TAG="${{ env.BACKEND_IMAGE }}:main"
          echo "Checking backend: $BACKEND_TAG"
          if docker manifest inspect "$BACKEND_TAG" >/dev/null 2>&1; then
            echo "‚úÖ Backend image successfully pushed: $BACKEND_TAG"
          else
            echo "‚ùå Failed to verify backend image push"
            VERIFY_OK=false
          fi
        else
          echo "‚ÑπÔ∏è Backend unchanged, skipping verify"
        fi

        if [ "$VERIFY_OK" = true ]; then
          echo "üéâ Docker image verification completed"
          exit 0
        else
          exit 1
        fi


  deploy-production:
    runs-on: self-hosted
    needs: [changes, docker-build-push]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment: production
    outputs:
      current-version: ${{ steps.set-versions.outputs.current }}
      previous-version: ${{ steps.set-versions.outputs.previous }}
      switched: ${{ steps.switch.outputs.switched }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Validate required secrets
      run: |
        echo "Validating required production secrets..."
        
        MISSING_SECRETS=""
        
        if [ -z "${{ secrets.DOCKER_USERNAME }}" ]; then
          MISSING_SECRETS="$MISSING_SECRETS DOCKER_USERNAME"
        fi
        
        if [ -z "${{ secrets.DOCKER_PASSWORD }}" ]; then
          MISSING_SECRETS="$MISSING_SECRETS DOCKER_PASSWORD"
        fi
        
        if [ -z "${{ secrets.MONGODB_ATLAS_URL }}" ]; then
          MISSING_SECRETS="$MISSING_SECRETS MONGODB_ATLAS_URL"
        fi
        
        if [ -z "${{ secrets.CLOUDNIRY_CLOUD_NAME }}" ]; then
          MISSING_SECRETS="$MISSING_SECRETS CLOUDNIRY_CLOUD_NAME"
        fi
        
        if [ -z "${{ secrets.CLOUDNIRY_API_KEY }}" ]; then
          MISSING_SECRETS="$MISSING_SECRETS CLOUDNIRY_API_KEY"
        fi
        
        if [ -z "${{ secrets.CLOUDNIRY_API_SECRET }}" ]; then
          MISSING_SECRETS="$MISSING_SECRETS CLOUDNIRY_API_SECRET"
        fi
        
        if [ -z "${{ secrets.ACCESS_TOKEN_SECRET }}" ]; then
          MISSING_SECRETS="$MISSING_SECRETS ACCESS_TOKEN_SECRET"
        fi
        
        if [ -z "${{ secrets.REFRESH_TOKEN_SECRET }}" ]; then
          MISSING_SECRETS="$MISSING_SECRETS REFRESH_TOKEN_SECRET"
        fi
        
        if [ -n "$MISSING_SECRETS" ]; then
          echo "‚ùå Missing required secrets:$MISSING_SECRETS"
          echo "Please add these secrets in repository settings"
          exit 1
        fi
        
        echo "‚úÖ All required secrets are configured"

    - name: Log in to Docker Hub
      uses: docker/login-action@v3
      with:
        registry: ${{ env.DOCKER_REGISTRY }}
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    - name: Set versions
      id: set-versions
      run: |
        CURRENT_VERSION="v${{ github.run_number }}"
        PREVIOUS_VERSION=$(docker images ${{ env.FRONTEND_IMAGE }} --format "{{.Tag}}" | grep "^v[0-9]" | sort -Vr | sed -n '2p')

        echo "CURRENT_VERSION=$CURRENT_VERSION" >> $GITHUB_ENV
        echo "PREVIOUS_VERSION=$PREVIOUS_VERSION" >> $GITHUB_ENV

        echo "current=$CURRENT_VERSION" >> $GITHUB_OUTPUT
        echo "previous=$PREVIOUS_VERSION" >> $GITHUB_OUTPUT

        echo "Deploy candidate version: $CURRENT_VERSION"
        echo "Detected previous version: $PREVIOUS_VERSION"

    - name: Compute component tags
      env:
        CHANGED_FRONTEND: ${{ needs.changes.outputs.frontend }}
        CHANGED_BACKEND: ${{ needs.changes.outputs.backend }}
      run: |
        if [ "$CHANGED_FRONTEND" = "true" ]; then
          FRONTEND_TAG="$CURRENT_VERSION"
        else
          FRONTEND_TAG="latest"
        fi
        if [ "$CHANGED_BACKEND" = "true" ]; then
          BACKEND_TAG="$CURRENT_VERSION"
        else
          BACKEND_TAG="latest"
        fi
        echo "Using tags -> FRONTEND_TAG=$FRONTEND_TAG, BACKEND_TAG=$BACKEND_TAG"
        echo "FRONTEND_TAG=$FRONTEND_TAG" >> $GITHUB_ENV
        echo "BACKEND_TAG=$BACKEND_TAG" >> $GITHUB_ENV

    - name: Pull Docker images for deployment
      env:
        CHANGED_FRONTEND: ${{ needs.changes.outputs.frontend }}
        CHANGED_BACKEND: ${{ needs.changes.outputs.backend }}
      run: |
        if [ "$CHANGED_FRONTEND" = "true" ]; then
          docker pull ${{ env.FRONTEND_IMAGE }}:$FRONTEND_TAG || { echo "‚ùå Failed to pull frontend tag $FRONTEND_TAG"; exit 1; }
          docker tag ${{ env.FRONTEND_IMAGE }}:$FRONTEND_TAG ${{ env.FRONTEND_IMAGE }}:latest
        else
          echo "‚ÑπÔ∏è Frontend unchanged, not pulling image"
        fi
        if [ "$CHANGED_BACKEND" = "true" ]; then
          docker pull ${{ env.BACKEND_IMAGE }}:$BACKEND_TAG || { echo "‚ùå Failed to pull backend tag $BACKEND_TAG"; exit 1; }
          docker tag ${{ env.BACKEND_IMAGE }}:$BACKEND_TAG ${{ env.BACKEND_IMAGE }}:latest
        else
          echo "‚ÑπÔ∏è Backend unchanged, not pulling image"
        fi

    - name: Start candidate containers (blue/green)
      env:
        CHANGED_FRONTEND: ${{ needs.changes.outputs.frontend }}
        CHANGED_BACKEND: ${{ needs.changes.outputs.backend }}
      run: |
        # Backend candidate on port 3777 (only if changed)
        if [ "$CHANGED_BACKEND" = "true" ]; then
          docker run -d \
          --name cynerza-backend-web-container-candidate \
          --restart unless-stopped \
          --memory=512m \
          --cpus=0.5 \
          --read-only \
          --tmpfs /tmp:rw,noexec,nosuid,size=100m \
          -p 3777:3776 \
          -e NODE_ENV=production \
          -e PORT=3776 \
          -e MONGODB_ATLAS_URL="${{ secrets.MONGODB_ATLAS_URL }}" \
          -e CLOUDNIRY_CLOUD_NAME="${{ secrets.CLOUDNIRY_CLOUD_NAME }}" \
          -e CLOUDNIRY_API_KEY="${{ secrets.CLOUDNIRY_API_KEY }}" \
          -e CLOUDNIRY_API_SECRET="${{ secrets.CLOUDNIRY_API_SECRET }}" \
          -e ACCESS_TOKEN_SECRET="${{ secrets.ACCESS_TOKEN_SECRET }}" \
          -e REFRESH_TOKEN_SECRET="${{ secrets.REFRESH_TOKEN_SECRET }}" \
          --security-opt=no-new-privileges:true \
          --cap-drop=ALL \
          --cap-add=NET_BIND_SERVICE \
          ${{ env.BACKEND_IMAGE }}:$BACKEND_TAG
        fi

        # Frontend candidate on port 8997 (only if changed)
        if [ "$CHANGED_FRONTEND" = "true" ]; then
          docker run -d \
          --name cynerza-frontend-web-container-candidate \
          --restart unless-stopped \
          --memory=256m \
          --cpus=0.25 \
          --read-only \
          --tmpfs /tmp:rw,noexec,nosuid,size=50m \
          -p 8997:8996 \
          --security-opt=no-new-privileges:true \
          --cap-drop=ALL \
          --cap-add=NET_BIND_SERVICE \
          ${{ env.FRONTEND_IMAGE }}:$FRONTEND_TAG
        fi

    

    - name: Wait for candidate containers to start
      run: |
        echo "Waiting for candidate containers to start..."
        sleep 45

    - name: Candidate Health Check
      env:
        CHANGED_FRONTEND: ${{ needs.changes.outputs.frontend }}
        CHANGED_BACKEND: ${{ needs.changes.outputs.backend }}
      run: |
        echo "Starting comprehensive production health checks..."
        
        check_service_health() {
          local url=$1
          local service_name=$2
          local max_attempts=12
          local attempt=1
          
          echo "Checking $service_name health at $url"
          
          while [ $attempt -le $max_attempts ]; do
            if curl -f -s -o /dev/null "$url"; then
              echo "‚úÖ $service_name health check passed (attempt $attempt)"
              return 0
            else
              echo "‚è≥ $service_name health check failed (attempt $attempt/$max_attempts)"
              if [ $attempt -eq $max_attempts ]; then
                echo "‚ùå $service_name failed health check after $max_attempts attempts"
                if [ "$service_name" = "Backend" ]; then
                  docker logs cynerza-backend-web-container-candidate --tail 50 || true
                else
                  docker logs cynerza-frontend-web-container-candidate --tail 50 || true
                fi
                return 1
              fi
              sleep 15
            fi
            attempt=$((attempt + 1))
          done
        }
        
        if [ "$CHANGED_BACKEND" = "true" ]; then
          check_service_health "http://localhost:3777/health" "Backend"
          BACKEND_RESULT=$?
        else
          # Validate stable backend is healthy if unchanged
          check_service_health "http://localhost:3776/health" "Backend"
          BACKEND_RESULT=$?
        fi
        
        if [ "$CHANGED_FRONTEND" = "true" ]; then
          check_service_health "http://localhost:8997" "Frontend"
          FRONTEND_RESULT=$?
        else
          # Validate stable frontend is healthy if unchanged
          check_service_health "http://localhost:8996" "Frontend"
          FRONTEND_RESULT=$?
        fi
        
        if [ "$CHANGED_BACKEND" = "true" ] && [ $BACKEND_RESULT -eq 0 ]; then
          echo "Testing additional backend endpoints on candidate..."
          if curl -f -s http://localhost:3777/ >/dev/null; then
            echo "‚úÖ Backend candidate root endpoint accessible"
          else
            echo "‚ö†Ô∏è Backend candidate root endpoint test failed"
          fi
        fi
        
        if [ $BACKEND_RESULT -ne 0 ] || [ $FRONTEND_RESULT -ne 0 ]; then
          echo "‚ùå Candidate health checks failed. Keeping existing containers running (if any)."
          echo "Cleaning up candidate containers..."
          docker logs cynerza-backend-web-container-candidate --tail 50 || true
          docker logs cynerza-frontend-web-container-candidate --tail 50 || true
          docker rm -f cynerza-backend-web-container-candidate cynerza-frontend-web-container-candidate || true
          exit 1
        fi
        echo "‚úÖ Candidate health checks passed"

    - name: Switch traffic to new version
      id: switch
      env:
        CHANGED_FRONTEND: ${{ needs.changes.outputs.frontend }}
        CHANGED_BACKEND: ${{ needs.changes.outputs.backend }}
      run: |
        echo "Switching traffic to -> FRONTEND:$FRONTEND_TAG BACKEND:$BACKEND_TAG"

        # Stop stable containers only after candidate is healthy
        if [ "$CHANGED_BACKEND" = "true" ]; then
          docker stop cynerza-backend-web-container || true
          docker rm cynerza-backend-web-container || true
        fi
        if [ "$CHANGED_FRONTEND" = "true" ]; then
          docker stop cynerza-frontend-web-container || true
          docker rm cynerza-frontend-web-container || true
        fi

        # Start stable containers on standard ports with the selected tags
        if [ "$CHANGED_BACKEND" = "true" ]; then
          docker run -d \
          --name cynerza-backend-web-container \
          --restart unless-stopped \
          --memory=512m \
          --cpus=0.5 \
          --read-only \
          --tmpfs /tmp:rw,noexec,nosuid,size=100m \
          -p 3776:3776 \
          -e NODE_ENV=production \
          -e PORT=3776 \
          -e MONGODB_ATLAS_URL="${{ secrets.MONGODB_ATLAS_URL }}" \
          -e CLOUDNIRY_CLOUD_NAME="${{ secrets.CLOUDNIRY_CLOUD_NAME }}" \
          -e CLOUDNIRY_API_KEY="${{ secrets.CLOUDNIRY_API_KEY }}" \
          -e CLOUDNIRY_API_SECRET="${{ secrets.CLOUDNIRY_API_SECRET }}" \
          -e ACCESS_TOKEN_SECRET="${{ secrets.ACCESS_TOKEN_SECRET }}" \
          -e REFRESH_TOKEN_SECRET="${{ secrets.REFRESH_TOKEN_SECRET }}" \
          --security-opt=no-new-privileges:true \
          --cap-drop=ALL \
          --cap-add=NET_BIND_SERVICE \
          ${{ env.BACKEND_IMAGE }}:$BACKEND_TAG
        fi

        if [ "$CHANGED_FRONTEND" = "true" ]; then
          docker run -d \
          --name cynerza-frontend-web-container \
          --restart unless-stopped \
          --memory=256m \
          --cpus=0.25 \
          --read-only \
          --tmpfs /tmp:rw,noexec,nosuid,size=50m \
          -p 8996:8996 \
          --security-opt=no-new-privileges:true \
          --cap-drop=ALL \
          --cap-add=NET_BIND_SERVICE \
          ${{ env.FRONTEND_IMAGE }}:$FRONTEND_TAG
        fi

        # Remove candidate containers
        [ "$CHANGED_BACKEND" = "true" ] && docker rm -f cynerza-backend-web-container-candidate || true
        [ "$CHANGED_FRONTEND" = "true" ] && docker rm -f cynerza-frontend-web-container-candidate || true

        echo "switched=true" >> $GITHUB_OUTPUT

    - name: Post-switch Health Check (stable ports)
      run: |
        echo "Validating services on stable ports..."
        for i in {1..12}; do
          if curl -f -s http://localhost:3776/health >/dev/null && curl -f -s http://localhost:8996 >/dev/null; then
            echo "‚úÖ Stable services healthy"
            exit 0
          fi
          echo "‚è≥ Waiting for stable services... ($i/12)" && sleep 10
        done
        echo "‚ùå Stable services failed health check after switch"
        exit 1

    - name: Clean up old versions
      run: |
        echo "Keeping last 5 versions for rollback"
        docker images ${{ env.FRONTEND_IMAGE }} --format "{{.Tag}}" | grep "^v[0-9]" | tail -n +6 | xargs -r -I {} docker rmi ${{ env.FRONTEND_IMAGE }}:{} || true
        docker images ${{ env.BACKEND_IMAGE }} --format "{{.Tag}}" | grep "^v[0-9]" | tail -n +6 | xargs -r -I {} docker rmi ${{ env.BACKEND_IMAGE }}:{} || true

    - name: Deployment Success Notification
      run: |
        echo "üöÄ Production deployment completed successfully!"
        echo "Frontend: http://localhost:8996"
        echo "Backend: http://localhost:3776"
        echo "Docker Images:"
        echo "  - ${{ env.FRONTEND_IMAGE }}:$FRONTEND_TAG"
        echo "  - ${{ env.BACKEND_IMAGE }}:$BACKEND_TAG"
        echo "  - ${{ env.FRONTEND_IMAGE }}:latest"
        echo "  - ${{ env.BACKEND_IMAGE }}:latest"
        echo "Deployed current-version id: $CURRENT_VERSION"
        echo "Previous version id: $PREVIOUS_VERSION"

  rollback-production:
    runs-on: self-hosted
    needs: [deploy-production]
    if: failure() && github.ref == 'refs/heads/main'
    
    steps:
    - name: Rollback to previous version
      run: |
        echo "üîÑ Rolling back to previous version due to deployment failure"
        
        docker stop cynerza-backend-web-container cynerza-frontend-web-container 2>/dev/null || echo "Containers not running"
        docker rm cynerza-backend-web-container cynerza-frontend-web-container 2>/dev/null || echo "Containers not found"
        
        AVAILABLE_VERSIONS=$(docker images ${{ env.FRONTEND_IMAGE }} --format "{{.Tag}}" 2>/dev/null | grep "^v[0-9]" | sort -V || echo "")
        
        if [ -z "$AVAILABLE_VERSIONS" ]; then
          echo "‚ùå No Docker images found for rollback. This appears to be a first deployment failure."
          echo "üîß Attempting to restore service by cleaning up failed state..."
          docker system prune -f 2>/dev/null || true
          echo "Manual intervention required to restore service."
          echo "Please check:"
          echo "1. Docker Hub credentials are correct"
          echo "2. Repository exists: ${{ env.FRONTEND_IMAGE }}"
          echo "3. Repository exists: ${{ env.BACKEND_IMAGE }}"
          exit 0
        fi
        
        VERSION_COUNT=$(echo "$AVAILABLE_VERSIONS" | wc -l)
        
        if [ "$VERSION_COUNT" -ge 2 ]; then
          ROLLBACK_VERSION=$(echo "$AVAILABLE_VERSIONS" | tail -2 | head -1)
        elif [ "$VERSION_COUNT" -eq 1 ]; then
          echo "‚ö†Ô∏è Only one version available, cannot rollback to previous version."
          echo "This appears to be the first deployment. Cleanup completed."
          exit 0
        else
          echo "‚ùå Unexpected state in version detection"
          exit 0
        fi
        
        if [ -n "$ROLLBACK_VERSION" ]; then
          echo "Rolling back to version: $ROLLBACK_VERSION"
          
          docker pull ${{ env.FRONTEND_IMAGE }}:$ROLLBACK_VERSION || echo "Frontend rollback image exists locally"
          docker pull ${{ env.BACKEND_IMAGE }}:$ROLLBACK_VERSION || echo "Backend rollback image exists locally"
          
          docker run -d \
            --name cynerza-backend-web-container \
            --restart unless-stopped \
            --memory=512m \
            --cpus=0.5 \
            --read-only \
            --tmpfs /tmp:rw,noexec,nosuid,size=100m \
            -p 3776:3776 \
            -e NODE_ENV=production \
            -e PORT=3776 \
            -e MONGODB_ATLAS_URL="${{ secrets.MONGODB_ATLAS_URL }}" \
            -e CLOUDNIRY_CLOUD_NAME="${{ secrets.CLOUDNIRY_CLOUD_NAME }}" \
            -e CLOUDNIRY_API_KEY="${{ secrets.CLOUDNIRY_API_KEY }}" \
            -e CLOUDNIRY_API_SECRET="${{ secrets.CLOUDNIRY_API_SECRET }}" \
            -e ACCESS_TOKEN_SECRET="${{ secrets.ACCESS_TOKEN_SECRET }}" \
            -e REFRESH_TOKEN_SECRET="${{ secrets.REFRESH_TOKEN_SECRET }}" \
            --security-opt=no-new-privileges:true \
            --cap-drop=ALL \
            --cap-add=NET_BIND_SERVICE \
            ${{ env.BACKEND_IMAGE }}:$ROLLBACK_VERSION
          
          docker run -d \
            --name cynerza-frontend-web-container \
            --restart unless-stopped \
            --memory=256m \
            --cpus=0.25 \
            --read-only \
            --tmpfs /tmp:rw,noexec,nosuid,size=50m \
            -p 8996:8996 \
            --security-opt=no-new-privileges:true \
            --cap-drop=ALL \
            --cap-add=NET_BIND_SERVICE \
            ${{ env.FRONTEND_IMAGE }}:$ROLLBACK_VERSION
          
          echo "Waiting for rollback containers to start..."
          sleep 45
          
          ROLLBACK_SUCCESS=true
          
          for i in {1..6}; do
            if curl -f -s http://localhost:3776/health >/dev/null; then
              echo "‚úÖ Backend rollback health check passed"
              break
            elif [ $i -eq 6 ]; then
              echo "‚ùå Backend rollback health check failed"
              ROLLBACK_SUCCESS=false
            else
              echo "‚è≥ Waiting for backend rollback... ($i/6)"
              sleep 10
            fi
          done
          
          for i in {1..6}; do
            if curl -f -s http://localhost:8996 >/dev/null; then
              echo "‚úÖ Frontend rollback health check passed"
              break
            elif [ $i -eq 6 ]; then
              echo "‚ùå Frontend rollback health check failed"
              ROLLBACK_SUCCESS=false
            else
              echo "‚è≥ Waiting for frontend rollback... ($i/6)"
              sleep 10
            fi
          done
          
          if [ "$ROLLBACK_SUCCESS" = true ]; then
            echo "‚úÖ Rollback to version $ROLLBACK_VERSION completed successfully"
          else
            echo "‚ùå Rollback failed - manual intervention required"
            docker logs cynerza-backend-web-container --tail 20 || true
            docker logs cynerza-frontend-web-container --tail 20 || true
            exit 1
          fi
        else
          echo "‚ùå No previous version found for rollback - manual intervention required"
          exit 1
        fi

  manual-rollback:
    runs-on: self-hosted
    if: github.event_name == 'workflow_dispatch' && inputs.rollback_to != ''
    steps:
    - name: Log in to Docker Hub
      uses: docker/login-action@v3
      with:
        registry: ${{ env.DOCKER_REGISTRY }}
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    - name: Rollback to specified version
      run: |
        TARGET="${{ inputs.rollback_to }}"
        echo "Rolling back to specific version: $TARGET"

        docker stop cynerza-backend-web-container cynerza-frontend-web-container 2>/dev/null || true
        docker rm cynerza-backend-web-container cynerza-frontend-web-container 2>/dev/null || true

        docker pull ${{ env.FRONTEND_IMAGE }}:$TARGET || { echo "‚ùå Frontend image tag not found: $TARGET"; exit 1; }
        docker pull ${{ env.BACKEND_IMAGE }}:$TARGET || { echo "‚ùå Backend image tag not found: $TARGET"; exit 1; }

        docker run -d \
          --name cynerza-backend-web-container \
          --restart unless-stopped \
          --memory=512m \
          --cpus=0.5 \
          --read-only \
          --tmpfs /tmp:rw,noexec,nosuid,size=100m \
          -p 3776:3776 \
          -e NODE_ENV=production \
          -e PORT=3776 \
          -e MONGODB_ATLAS_URL="${{ secrets.MONGODB_ATLAS_URL }}" \
          -e CLOUDNIRY_CLOUD_NAME="${{ secrets.CLOUDNIRY_CLOUD_NAME }}" \
          -e CLOUDNIRY_API_KEY="${{ secrets.CLOUDNIRY_API_KEY }}" \
          -e CLOUDNIRY_API_SECRET="${{ secrets.CLOUDNIRY_API_SECRET }}" \
          -e ACCESS_TOKEN_SECRET="${{ secrets.ACCESS_TOKEN_SECRET }}" \
          -e REFRESH_TOKEN_SECRET="${{ secrets.REFRESH_TOKEN_SECRET }}" \
          --security-opt=no-new-privileges:true \
          --cap-drop=ALL \
          --cap-add=NET_BIND_SERVICE \
          ${{ env.BACKEND_IMAGE }}:$TARGET

        docker run -d \
          --name cynerza-frontend-web-container \
          --restart unless-stopped \
          --memory=256m \
          --cpus=0.25 \
          --read-only \
          --tmpfs /tmp:rw,noexec,nosuid,size=50m \
          -p 8996:8996 \
          --security-opt=no-new-privileges:true \
          --cap-drop=ALL \
          --cap-add=NET_BIND_SERVICE \
          ${{ env.FRONTEND_IMAGE }}:$TARGET

        echo "Validating rollback services..."
        for i in {1..12}; do
          if curl -f -s http://localhost:3776/health >/dev/null && curl -f -s http://localhost:8996 >/dev/null; then
            echo "‚úÖ Rollback to $TARGET healthy"
            exit 0
          fi
          echo "‚è≥ Waiting for rollback services... ($i/12)" && sleep 10
        done
        echo "‚ùå Rollback to $TARGET failed health check"
        exit 1

  cleanup-on-failure:
    runs-on: self-hosted
    needs: [deploy-production]
    if: failure()
    
    steps:
    - name: Cleanup failed deployment artifacts
      run: |
        echo "üßπ Cleaning up failed deployment artifacts"
        
        docker container prune -f
        
        docker image prune -f
        
        echo "Cleanup completed"
