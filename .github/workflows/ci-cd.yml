name: Production CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  DOCKER_REGISTRY: docker.io
  FRONTEND_IMAGE: cynerza/cynerza-frontend-web
  BACKEND_IMAGE: cynerza/cynerza-backend-web
  NODE_VERSION: '20'

jobs:
  security-scan:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'table'
        exit-code: '1'
        ignore-unfixed: true
        severity: 'CRITICAL,HIGH'

    - name: Check for hardcoded secrets in code
      run: |
        echo "üîç Scanning for hardcoded secrets..."
        
        FINDINGS=""
        
        API_KEYS=$(grep -r -E '['"'"']?(sk-|pk_|rk_|ak_)[a-zA-Z0-9]{20,}['"'"']?' --include="*.js" --include="*.ts" --exclude-dir=node_modules . || true)
        if [ -n "$API_KEYS" ]; then
          FINDINGS="$FINDINGS\nHardcoded API Keys:\n$API_KEYS"
        fi
        
        AWS_KEYS=$(grep -r -E '['"'"'"](AKIA[0-9A-Z]{16})['"'"'"]' --include="*.js" --include="*.ts" --exclude-dir=node_modules . || true)
        if [ -n "$AWS_KEYS" ]; then
          FINDINGS="$FINDINGS\nAWS Keys:\n$AWS_KEYS"
        fi
        
        GH_TOKENS=$(grep -r -E '['"'"'"](ghp_|gho_|ghu_|ghs_)[a-zA-Z0-9]{36,}['"'"'"]' --include="*.js" --include="*.ts" --exclude-dir=node_modules . || true)
        if [ -n "$GH_TOKENS" ]; then
          FINDINGS="$FINDINGS\nGitHub Tokens:\n$GH_TOKENS"
        fi
        
        HARDCODED_PASSWORDS=$(grep -r -E 'password\s*[:=]\s*['"'"'"][^'"'"'"process.env][^'"'"'"\s]{8,}['"'"'"]' --include="*.js" --include="*.ts" --exclude-dir=node_modules . | grep -v -E "(type\s|interface\s|String,|string;)" || true)
        if [ -n "$HARDCODED_PASSWORDS" ]; then
          FINDINGS="$FINDINGS\nHardcoded Passwords:\n$HARDCODED_PASSWORDS"
        fi
        
        DB_URLS=$(grep -r -E '(mongodb|postgres|mysql)://[^:]+:[^@/]+@' --include="*.js" --include="*.ts" --exclude-dir=node_modules . | grep -v "process.env" || true)
        if [ -n "$DB_URLS" ]; then
          FINDINGS="$FINDINGS\nDatabase URLs with credentials:\n$DB_URLS"
        fi
        
        JWT_SECRETS=$(grep -r -E 'jwt.*secret.*[:=]\s*['"'"'"][^'"'"'"process.env][^'"'"'"\s]{16,}['"'"'"]' --include="*.js" --include="*.ts" --exclude-dir=node_modules . || true)
        if [ -n "$JWT_SECRETS" ]; then
          FINDINGS="$FINDINGS\nJWT Secrets:\n$JWT_SECRETS"
        fi
        
        if [ -n "$FINDINGS" ]; then
          echo -e "‚ùå Potential hardcoded secrets found:$FINDINGS"
          echo ""
          echo "Please ensure secrets are stored in environment variables, not hardcoded in source code."
          exit 1
        else
          echo "‚úÖ No hardcoded secrets detected"
        fi

    - name: Check for security vulnerabilities in dependencies
      run: |
        echo "üîç Checking for dependency vulnerabilities..."
        
        if [ -f "package-lock.json" ]; then
          npm audit --audit-level=high --production || {
            echo "‚ùå Frontend dependencies have high/critical vulnerabilities"
            echo "Run 'npm audit fix' to resolve issues"
            exit 1
          }
        fi
        
        if [ -f "CYNERZA-ADMIN-BACKEND/package-lock.json" ]; then
          cd CYNERZA-ADMIN-BACKEND
          npm audit --audit-level=high --production || {
            echo "‚ùå Backend dependencies have high/critical vulnerabilities"
            echo "Run 'npm audit fix' in CYNERZA-ADMIN-BACKEND to resolve issues"
            exit 1
          }
          cd ..
        fi
        
        echo "‚úÖ No high/critical dependency vulnerabilities found"

    - name: Check Dockerfile security best practices
      run: |
        echo "üîç Checking Dockerfile security..."
        
        DOCKERFILE_ISSUES=""
        
        if [ -f "Dockerfile" ]; then
          if ! grep -q "USER.*[^0]" Dockerfile; then
            DOCKERFILE_ISSUES="$DOCKERFILE_ISSUES\n- Frontend Dockerfile: Should run as non-root user"
          fi
          
          if grep -q "FROM.*:latest" Dockerfile; then
            DOCKERFILE_ISSUES="$DOCKERFILE_ISSUES\n- Frontend Dockerfile: Avoid using ':latest' tag, pin specific versions"
          fi
        fi
        
        if [ -f "CYNERZA-ADMIN-BACKEND/Dockerfile" ]; then
          if ! grep -q "USER.*[^0]" CYNERZA-ADMIN-BACKEND/Dockerfile; then
            DOCKERFILE_ISSUES="$DOCKERFILE_ISSUES\n- Backend Dockerfile: Should run as non-root user"
          fi
          
          if grep -q "FROM.*:latest" CYNERZA-ADMIN-BACKEND/Dockerfile; then
            DOCKERFILE_ISSUES="$DOCKERFILE_ISSUES\n- Backend Dockerfile: Avoid using ':latest' tag, pin specific versions"
          fi
        fi
        
        if [ -n "$DOCKERFILE_ISSUES" ]; then
          echo -e "‚ö†Ô∏è Dockerfile security recommendations:$DOCKERFILE_ISSUES"
          echo ""
          echo "Consider addressing these security best practices."
        else
          echo "‚úÖ Dockerfile security checks passed"
        fi

  frontend-build:
    runs-on: ubuntu-latest
    needs: security-scan
    outputs:
      build-success: ${{ steps.build-check.outputs.success }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: Install frontend dependencies
      run: npm ci

    - name: Run ESLint
      run: npm run lint

    - name: Run TypeScript check
      run: npx tsc --noEmit

    - name: Build frontend
      run: npm run build

    - name: Test frontend build
      id: build-check
      run: |
        if [ -d "dist" ] && [ "$(ls -A dist)" ]; then
          echo "‚úÖ Frontend build successful"
          echo "success=true" >> $GITHUB_OUTPUT
        else
          echo "‚ùå Frontend build failed - dist directory empty"
          echo "success=false" >> $GITHUB_OUTPUT
          exit 1
        fi

    - name: Cache frontend dist
      if: success()
      uses: actions/cache/save@v3
      with:
        path: ./dist
        key: frontend-dist-${{ github.sha }}

  backend-build:
    runs-on: ubuntu-latest
    needs: security-scan
    defaults:
      run:
        working-directory: ./CYNERZA-ADMIN-BACKEND
    outputs:
      build-success: ${{ steps.build-check.outputs.success }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: './CYNERZA-ADMIN-BACKEND/package-lock.json'

    - name: Install backend dependencies
      run: npm ci

    - name: Validate backend startup
      run: |
        echo "Starting backend validation..."
        
        export NODE_ENV=development
        export PORT=3776
        export MONGODB_URL="mongodb://localhost:27017/test"
        export CLOUDNIRY_CLOUD_NAME="test"
        export CLOUDNIRY_API_KEY="test"
        export CLOUDNIRY_API_SECRET="test"
        export ACCESS_TOKEN_SECRET="test-secret"
        export REFRESH_TOKEN_SECRET="test-refresh-secret"
        
        timeout 30s npm run dev &
        PID=$!
        
        sleep 15
        
        if kill -0 $PID 2>/dev/null; then
          echo "‚úÖ Backend starts successfully"
          kill $PID
          wait $PID 2>/dev/null || true
        else
          echo "‚ùå Backend failed to start"
          exit 1
        fi

    - name: Run backend build check
      id: build-check
      run: |
        npm run build
        echo "‚úÖ Backend build successful"
        echo "success=true" >> $GITHUB_OUTPUT

    - name: Cache backend src
      if: success()
      uses: actions/cache/save@v3
      with:
        path: ./CYNERZA-ADMIN-BACKEND/src
        key: backend-src-${{ github.sha }}

  docker-build-push:
    runs-on: ubuntu-latest
    needs: [frontend-build, backend-build]
    if: success() && github.event_name != 'pull_request'
    outputs:
      frontend-image-tag: ${{ env.FRONTEND_IMAGE }}:${{ github.sha }}
      backend-image-tag: ${{ env.BACKEND_IMAGE }}:${{ github.sha }}
      frontend-image-digest: ${{ steps.frontend-build.outputs.digest }}
      backend-image-digest: ${{ steps.backend-build.outputs.digest }}
    
    steps:
    - name: Verify both builds succeeded
      run: |
        echo "üîç Verifying both frontend and backend builds succeeded..."
        
        FRONTEND_SUCCESS="${{ needs.frontend-build.outputs.build-success }}"
        BACKEND_SUCCESS="${{ needs.backend-build.outputs.build-success }}"
        
        echo "Frontend build success: $FRONTEND_SUCCESS"
        echo "Backend build success: $BACKEND_SUCCESS"
        
        if [ "$FRONTEND_SUCCESS" = "true" ] && [ "$BACKEND_SUCCESS" = "true" ]; then
          echo "‚úÖ Both builds successful - proceeding with Docker push"
        else
          echo "‚ùå One or both builds failed - aborting Docker push"
          echo "Frontend: $FRONTEND_SUCCESS, Backend: $BACKEND_SUCCESS"
          exit 1
        fi

    - name: Checkout code
      uses: actions/checkout@v4

    - name: Restore frontend dist cache
      uses: actions/cache/restore@v3
      with:
        path: ./dist
        key: frontend-dist-${{ github.sha }}
        fail-on-cache-miss: true

    - name: Restore backend src cache
      uses: actions/cache/restore@v3
      with:
        path: ./CYNERZA-ADMIN-BACKEND/src
        key: backend-src-${{ github.sha }}
        fail-on-cache-miss: true

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to Docker Hub
      uses: docker/login-action@v3
      with:
        registry: ${{ env.DOCKER_REGISTRY }}
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    - name: Create Docker repositories if needed
      run: |
        echo "üì¶ Ensuring Docker Hub repositories are ready..."
        
        create_repo_if_needed() {
          local repo_name=$1
          local image_name=$2
          
          echo "Checking repository: $image_name"
          
          REPO_EXISTS=$(curl -s -o /dev/null -w "%{http_code}" \
            "https://hub.docker.com/v2/repositories/$image_name/" || echo "000")
          
          if [ "$REPO_EXISTS" = "200" ]; then
            echo "‚úÖ Repository $image_name exists"
          else
            echo "‚ö†Ô∏è Repository $image_name does not exist - will be created on push"
            echo "Make sure your Docker Hub account has permission to create repositories"
          fi
        }
        
        create_repo_if_needed "frontend" "${{ env.FRONTEND_IMAGE }}"
        create_repo_if_needed "backend" "${{ env.BACKEND_IMAGE }}"

    - name: Extract metadata for Frontend Docker
      id: frontend-meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.FRONTEND_IMAGE }}
        tags: |
          type=ref,event=branch
          type=ref,event=pr
          type=sha
          type=semver,pattern={{version}}
          type=semver,pattern={{major}}.{{minor}}
          type=raw,value=v${{ github.run_number }}
          type=raw,value=latest,enable={{is_default_branch}}

    - name: Extract metadata for Backend Docker
      id: backend-meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.BACKEND_IMAGE }}
        tags: |
          type=ref,event=branch
          type=ref,event=pr
          type=sha
          type=semver,pattern={{version}}
          type=semver,pattern={{major}}.{{minor}}
          type=raw,value=v${{ github.run_number }}
          type=raw,value=latest,enable={{is_default_branch}}

    - name: Build and push Frontend Docker image
      id: frontend-build
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile
        push: true
        tags: ${{ steps.frontend-meta.outputs.tags }}
        labels: ${{ steps.frontend-meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: Build and push Backend Docker image
      id: backend-build
      uses: docker/build-push-action@v5
      with:
        context: ./CYNERZA-ADMIN-BACKEND
        file: ./CYNERZA-ADMIN-BACKEND/Dockerfile
        push: true
        tags: ${{ steps.backend-meta.outputs.tags }}
        labels: ${{ steps.backend-meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        
    - name: Verify both pushes succeeded
      run: |
        echo "üîç Verifying both Docker images were pushed successfully..."
        
        FRONTEND_TAG="${{ env.FRONTEND_IMAGE }}:main"
        BACKEND_TAG="${{ env.BACKEND_IMAGE }}:main"
        
        echo "Checking frontend: $FRONTEND_TAG"
        if docker manifest inspect "$FRONTEND_TAG" >/dev/null 2>&1; then
          echo "‚úÖ Frontend image successfully pushed: $FRONTEND_TAG"
        else
          echo "‚ùå Failed to verify frontend image push"
          exit 1
        fi
        
        echo "Checking backend: $BACKEND_TAG"
        if docker manifest inspect "$BACKEND_TAG" >/dev/null 2>&1; then
          echo "‚úÖ Backend image successfully pushed: $BACKEND_TAG"
        else
          echo "‚ùå Failed to verify backend image push"
          exit 1
        fi
        
        echo "üéâ Both Docker images successfully pushed to Docker Hub!"


  deploy-production:
    runs-on: self-hosted
    needs: [docker-build-push]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment: production
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Validate required secrets
      run: |
        echo "Validating required production secrets..."
        
        MISSING_SECRETS=""
        
        if [ -z "${{ secrets.DOCKER_USERNAME }}" ]; then
          MISSING_SECRETS="$MISSING_SECRETS DOCKER_USERNAME"
        fi
        
        if [ -z "${{ secrets.DOCKER_PASSWORD }}" ]; then
          MISSING_SECRETS="$MISSING_SECRETS DOCKER_PASSWORD"
        fi
        
        if [ -z "${{ secrets.MONGODB_ATLAS_URL }}" ]; then
          MISSING_SECRETS="$MISSING_SECRETS MONGODB_ATLAS_URL"
        fi
        
        if [ -z "${{ secrets.CLOUDNIRY_CLOUD_NAME }}" ]; then
          MISSING_SECRETS="$MISSING_SECRETS CLOUDNIRY_CLOUD_NAME"
        fi
        
        if [ -z "${{ secrets.CLOUDNIRY_API_KEY }}" ]; then
          MISSING_SECRETS="$MISSING_SECRETS CLOUDNIRY_API_KEY"
        fi
        
        if [ -z "${{ secrets.CLOUDNIRY_API_SECRET }}" ]; then
          MISSING_SECRETS="$MISSING_SECRETS CLOUDNIRY_API_SECRET"
        fi
        
        if [ -z "${{ secrets.ACCESS_TOKEN_SECRET }}" ]; then
          MISSING_SECRETS="$MISSING_SECRETS ACCESS_TOKEN_SECRET"
        fi
        
        if [ -z "${{ secrets.REFRESH_TOKEN_SECRET }}" ]; then
          MISSING_SECRETS="$MISSING_SECRETS REFRESH_TOKEN_SECRET"
        fi
        
        if [ -n "$MISSING_SECRETS" ]; then
          echo "‚ùå Missing required secrets:$MISSING_SECRETS"
          echo "Please add these secrets in repository settings"
          exit 1
        fi
        
        echo "‚úÖ All required secrets are configured"

    - name: Log in to Docker Hub
      uses: docker/login-action@v3
      with:
        registry: ${{ env.DOCKER_REGISTRY }}
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    - name: Create version backup and deploy
      run: |
        CURRENT_VERSION="v${{ github.run_number }}"
        PREVIOUS_VERSION=$(docker images ${{ env.FRONTEND_IMAGE }} --format "{{.Tag}}" | grep "^v[0-9]" | head -1)
        
        echo "CURRENT_VERSION=$CURRENT_VERSION" >> $GITHUB_ENV
        echo "PREVIOUS_VERSION=$PREVIOUS_VERSION" >> $GITHUB_ENV
        
        echo "Deploying version: $CURRENT_VERSION"
        echo "Previous version for rollback: $PREVIOUS_VERSION"

    - name: Pull versioned Docker images
      run: |
        docker pull ${{ env.FRONTEND_IMAGE }}:${{ env.CURRENT_VERSION }}
        docker pull ${{ env.BACKEND_IMAGE }}:${{ env.CURRENT_VERSION }}
        
        docker tag ${{ env.FRONTEND_IMAGE }}:${{ env.CURRENT_VERSION }} ${{ env.FRONTEND_IMAGE }}:latest
        docker tag ${{ env.BACKEND_IMAGE }}:${{ env.CURRENT_VERSION }} ${{ env.BACKEND_IMAGE }}:latest

    - name: Stop existing containers
      run: |
        docker stop cynerza-backend-web-container cynerza-frontend-web-container || true
        docker rm cynerza-backend-web-container cynerza-frontend-web-container || true
        sleep 5

    - name: Deploy Backend Container
      run: |
        docker run -d \
          --name cynerza-backend-web-container \
          --restart unless-stopped \
          --memory=512m \
          --cpus=0.5 \
          --read-only \
          --tmpfs /tmp:rw,noexec,nosuid,size=100m \
          -p 3776:3776 \
          -e NODE_ENV=production \
          -e PORT=3776 \
          -e MONGODB_ATLAS_URL="${{ secrets.MONGODB_ATLAS_URL }}" \
          -e CLOUDNIRY_CLOUD_NAME="${{ secrets.CLOUDNIRY_CLOUD_NAME }}" \
          -e CLOUDNIRY_API_KEY="${{ secrets.CLOUDNIRY_API_KEY }}" \
          -e CLOUDNIRY_API_SECRET="${{ secrets.CLOUDNIRY_API_SECRET }}" \
          -e ACCESS_TOKEN_SECRET="${{ secrets.ACCESS_TOKEN_SECRET }}" \
          -e REFRESH_TOKEN_SECRET="${{ secrets.REFRESH_TOKEN_SECRET }}" \
          --security-opt=no-new-privileges:true \
          --cap-drop=ALL \
          --cap-add=NET_BIND_SERVICE \
          ${{ env.BACKEND_IMAGE }}:latest

    - name: Deploy Frontend Container
      run: |
        docker run -d \
          --name cynerza-frontend-web-container \
          --restart unless-stopped \
          --memory=256m \
          --cpus=0.25 \
          --read-only \
          --tmpfs /tmp:rw,noexec,nosuid,size=50m \
          -p 8996:8996 \
          --security-opt=no-new-privileges:true \
          --cap-drop=ALL \
          --cap-add=NET_BIND_SERVICE \
          ${{ env.FRONTEND_IMAGE }}:latest

    - name: Wait for containers to start
      run: |
        echo "Waiting for containers to start..."
        sleep 45

    - name: Production Health Check
      run: |
        echo "Starting comprehensive production health checks..."
        
        check_service_health() {
          local url=$1
          local service_name=$2
          local max_attempts=12
          local attempt=1
          
          echo "Checking $service_name health at $url"
          
          while [ $attempt -le $max_attempts ]; do
            if curl -f -s -o /dev/null "$url"; then
              echo "‚úÖ $service_name health check passed (attempt $attempt)"
              return 0
            else
              echo "‚è≥ $service_name health check failed (attempt $attempt/$max_attempts)"
              if [ $attempt -eq $max_attempts ]; then
                echo "‚ùå $service_name failed health check after $max_attempts attempts"
                docker logs cynerza-${service_name,,}-web-container --tail 50 || true
                return 1
              fi
              sleep 15
            fi
            attempt=$((attempt + 1))
          done
        }
        
        check_service_health "http://localhost:3776/health" "Backend"
        BACKEND_RESULT=$?
        
        check_service_health "http://localhost:8996" "Frontend"
        FRONTEND_RESULT=$?
        
        if [ $BACKEND_RESULT -eq 0 ]; then
          echo "Testing additional backend endpoints..."
          if curl -f -s http://localhost:3776/ >/dev/null; then
            echo "‚úÖ Backend root endpoint accessible"
          else
            echo "‚ö†Ô∏è Backend root endpoint test failed"
          fi
        fi
        
        if [ $BACKEND_RESULT -ne 0 ] || [ $FRONTEND_RESULT -ne 0 ]; then
          echo "‚ùå Production health checks failed, triggering rollback"
          exit 1
        fi
        
        echo "‚úÖ All production health checks passed successfully"
        
        echo "Container status:"
        docker ps | grep cynerza
        
        echo "Memory usage:"
        docker stats --no-stream --format "table {{.Name}}\t{{.CPUPerc}}\t{{.MemUsage}}" cynerza-backend-web-container cynerza-frontend-web-container || true

    - name: Clean up old versions
      run: |
        echo "Keeping last 5 versions for rollback"
        docker images ${{ env.FRONTEND_IMAGE }} --format "{{.Tag}}" | grep "^v[0-9]" | tail -n +6 | xargs -r -I {} docker rmi ${{ env.FRONTEND_IMAGE }}:{} || true
        docker images ${{ env.BACKEND_IMAGE }} --format "{{.Tag}}" | grep "^v[0-9]" | tail -n +6 | xargs -r -I {} docker rmi ${{ env.BACKEND_IMAGE }}:{} || true

    - name: Deployment Success Notification
      run: |
        echo "üöÄ Production deployment completed successfully!"
        echo "Frontend: http://localhost:8996"
        echo "Backend: http://localhost:3776"
        echo "Docker Images:"
        echo "  - ${{ env.FRONTEND_IMAGE }}:${{ env.CURRENT_VERSION }}"
        echo "  - ${{ env.BACKEND_IMAGE }}:${{ env.CURRENT_VERSION }}"
        echo "  - ${{ env.FRONTEND_IMAGE }}:latest"
        echo "  - ${{ env.BACKEND_IMAGE }}:latest"
        echo "Deployed version: ${{ env.CURRENT_VERSION }}"
        echo "Previous version: ${{ env.PREVIOUS_VERSION }}"

  rollback-production:
    runs-on: self-hosted
    needs: [deploy-production]
    if: failure() && github.ref == 'refs/heads/main'
    
    steps:
    - name: Rollback to previous version
      run: |
        echo "üîÑ Rolling back to previous version due to deployment failure"
        
        docker stop cynerza-backend-web-container cynerza-frontend-web-container 2>/dev/null || echo "Containers not running"
        docker rm cynerza-backend-web-container cynerza-frontend-web-container 2>/dev/null || echo "Containers not found"
        
        AVAILABLE_VERSIONS=$(docker images ${{ env.FRONTEND_IMAGE }} --format "{{.Tag}}" 2>/dev/null | grep "^v[0-9]" | sort -V || echo "")
        
        if [ -z "$AVAILABLE_VERSIONS" ]; then
          echo "‚ùå No Docker images found for rollback. This appears to be a first deployment failure."
          echo "üîß Attempting to restore service by cleaning up failed state..."
          docker system prune -f 2>/dev/null || true
          echo "Manual intervention required to restore service."
          echo "Please check:"
          echo "1. Docker Hub credentials are correct"
          echo "2. Repository exists: ${{ env.FRONTEND_IMAGE }}"
          echo "3. Repository exists: ${{ env.BACKEND_IMAGE }}"
          exit 0
        fi
        
        VERSION_COUNT=$(echo "$AVAILABLE_VERSIONS" | wc -l)
        
        if [ "$VERSION_COUNT" -ge 2 ]; then
          ROLLBACK_VERSION=$(echo "$AVAILABLE_VERSIONS" | tail -2 | head -1)
        elif [ "$VERSION_COUNT" -eq 1 ]; then
          echo "‚ö†Ô∏è Only one version available, cannot rollback to previous version."
          echo "This appears to be the first deployment. Cleanup completed."
          exit 0
        else
          echo "‚ùå Unexpected state in version detection"
          exit 0
        fi
        
        if [ -n "$ROLLBACK_VERSION" ]; then
          echo "Rolling back to version: $ROLLBACK_VERSION"
          
          docker pull ${{ env.FRONTEND_IMAGE }}:$ROLLBACK_VERSION || echo "Frontend rollback image exists locally"
          docker pull ${{ env.BACKEND_IMAGE }}:$ROLLBACK_VERSION || echo "Backend rollback image exists locally"
          
          docker run -d \
            --name cynerza-backend-web-container \
            --restart unless-stopped \
            --memory=512m \
            --cpus=0.5 \
            --read-only \
            --tmpfs /tmp:rw,noexec,nosuid,size=100m \
            -p 3776:3776 \
            -e NODE_ENV=production \
            -e PORT=3776 \
            -e MONGODB_ATLAS_URL="${{ secrets.MONGODB_ATLAS_URL }}" \
            -e CLOUDNIRY_CLOUD_NAME="${{ secrets.CLOUDNIRY_CLOUD_NAME }}" \
            -e CLOUDNIRY_API_KEY="${{ secrets.CLOUDNIRY_API_KEY }}" \
            -e CLOUDNIRY_API_SECRET="${{ secrets.CLOUDNIRY_API_SECRET }}" \
            -e ACCESS_TOKEN_SECRET="${{ secrets.ACCESS_TOKEN_SECRET }}" \
            -e REFRESH_TOKEN_SECRET="${{ secrets.REFRESH_TOKEN_SECRET }}" \
            --security-opt=no-new-privileges:true \
            --cap-drop=ALL \
            --cap-add=NET_BIND_SERVICE \
            ${{ env.BACKEND_IMAGE }}:$ROLLBACK_VERSION
          
          docker run -d \
            --name cynerza-frontend-web-container \
            --restart unless-stopped \
            --memory=256m \
            --cpus=0.25 \
            --read-only \
            --tmpfs /tmp:rw,noexec,nosuid,size=50m \
            -p 8996:8996 \
            --security-opt=no-new-privileges:true \
            --cap-drop=ALL \
            --cap-add=NET_BIND_SERVICE \
            ${{ env.FRONTEND_IMAGE }}:$ROLLBACK_VERSION
          
          echo "Waiting for rollback containers to start..."
          sleep 45
          
          ROLLBACK_SUCCESS=true
          
          for i in {1..6}; do
            if curl -f -s http://localhost:3776/health >/dev/null; then
              echo "‚úÖ Backend rollback health check passed"
              break
            elif [ $i -eq 6 ]; then
              echo "‚ùå Backend rollback health check failed"
              ROLLBACK_SUCCESS=false
            else
              echo "‚è≥ Waiting for backend rollback... ($i/6)"
              sleep 10
            fi
          done
          
          for i in {1..6}; do
            if curl -f -s http://localhost:8996 >/dev/null; then
              echo "‚úÖ Frontend rollback health check passed"
              break
            elif [ $i -eq 6 ]; then
              echo "‚ùå Frontend rollback health check failed"
              ROLLBACK_SUCCESS=false
            else
              echo "‚è≥ Waiting for frontend rollback... ($i/6)"
              sleep 10
            fi
          done
          
          if [ "$ROLLBACK_SUCCESS" = true ]; then
            echo "‚úÖ Rollback to version $ROLLBACK_VERSION completed successfully"
          else
            echo "‚ùå Rollback failed - manual intervention required"
            docker logs cynerza-backend-web-container --tail 20 || true
            docker logs cynerza-frontend-web-container --tail 20 || true
            exit 1
          fi
        else
          echo "‚ùå No previous version found for rollback - manual intervention required"
          exit 1
        fi

  cleanup-on-failure:
    runs-on: self-hosted
    needs: [deploy-production]
    if: failure()
    
    steps:
    - name: Cleanup failed deployment artifacts
      run: |
        echo "üßπ Cleaning up failed deployment artifacts"
        
        docker container prune -f
        
        docker image prune -f
        
        echo "Cleanup completed"
